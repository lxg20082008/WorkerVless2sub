name: buildAndDeployWorker
on:
  push:
    branches:
      - lxg20082008-patch-1
  schedule:
    - cron: "0 05 * * 1,3,5,0" #At 05:00 on Monday, Wednesday, Friday, and Sunday.
  workflow_dispatch: # 手动触发
    inputs:
      branch:
        description: 'Branch name'
        required: true
        default: 'lxg20082008-patch-1' # 默认分支

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - uses: actions/checkout@v4
      # - name: Set Compatibility Date
      #   id: set_date
      #   run: echo "::set-output name=date::$(date +%Y-%m-%d)"

      - name: Set secrets in wrangler.toml
        run: |
          awk -v UUID="${{ secrets.UUID }}" \
              -v PATH="${{ secrets.PATH }}" \
              -v HOST="${{ secrets.HOST }}" \
              -v TOKEN="${{ secrets.TOKEN }}" \
              -v ADDAPI="${{ secrets.ADDAPI }}" \
              -v ADDCSV="${{ secrets.ADDCSV }}" \
              -v ADD="${{ secrets.ADD }}" \
              '{ gsub(/\${{ secrets.UUID }}/, UUID); \
                 gsub(/\${{ secrets.PATH }}/, PATH); \
                 gsub(/\${{ secrets.HOST }}/, HOST); \
                 gsub(/\${{ secrets.TOKEN }}/, TOKEN); \
                 gsub(/\${{ secrets.ADDAPI }}/, ADDAPI); \
                 gsub(/\${{ secrets.ADDCSV }}/, ADDCSV); \
                 gsub(/\${{ secrets.ADD }}/, ADD); \
                 print }' wrangler.toml > wrangler.tmp && mv wrangler.tmp wrangler.toml

      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: .
          command: deploy _worker.js --compatibility-date 2024-04-13 --name ${{ secrets.SCRIPT_NAME }} # --compatibility-date ${{ steps.set_date.outputs.date }}
